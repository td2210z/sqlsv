CREATE DATABASE OPTAP3
GO
USE ONTAP3
GO

CREATE TABLE HANGHOA(
    MAHANG CHAR(10) NOT NULL,
	TENHANG NVARCHAR(50) ,
	DVT NCHAR(15) ,
	CONSTRAINT PK_HH PRIMARY KEY (MAHANG)

)

insert INTO HANGHOA(MAHANG , TENHANG , DVT)
VALUES('HH01' , 'QUAN J01' , 'CAI'),
('HH02' , 'QUAN J01' , 'CAI'),
('HH03' , 'QUAN J03' , 'CAI'),
('HH04' , 'AO AO01' , 'CAI'),
('HH05' , 'AO AO02' , 'CAI')


CREATE TABLE KHACH(
    MAKHACH CHAR(10) NOT NULL, 
	TENKHACH NVARCHAR(50) NOT NULL,
	DIACHI NVARCHAR(50) NOT NULL , 
	DIENTHOAI CHAR(15) NOT NULL , 
	GIOITINH BIT NOT NULL , 
	CONSTRAINT PK_KHACH PRIMARY KEY (MAKHACH)
)

INSERT INTO KHACH(MAKHACH , TENKHACH , DIACHI , DIENTHOAI , GIOITINH)
VALUES('KH01' , 'NGUYEN THE AN' , 'NGUYEN TRAI , THANH XUAN , HA NOI' , '12121212' , 0),
('KH02' , 'PHAM THE DIEM' , 'NGUYEN TRAI , THANH XUAN , HA NOI' , '12121212' , 1),
('KH03' , 'TRAN MAI HOA' , 'NGUYEN TRAI , THANH XUAN , HA NOI' , '12121212' , 1),
('KH04' , 'MAI THI HUONG' , 'NGUYEN TRAI , THANH XUAN , HA NOI' , '12121212' , 0),
('KH05' , 'PHAM VAN NINH' , 'NGUYEN TRAI , THANH XUAN , HA NOI' , '12121212' , 1)


CREATE TABLE HOADON(
    MAHD CHAR(10) NOT NULL , 
	MAHANG CHAR(10) NOT NULL , 
	NGAYLAP DATE ,
	SOLUONG NUMERIC(18 , 0) ,
	DONGIA NUMERIC(18 , 0) , 
	TRIGIAHD NUMERIC(18 , 0) DEFAULT NULL, 
	NGAYXUAT DATE , 
	MAKH CHAR(10) ,
	CONSTRAINT CPK_HD PRIMARY KEY (MAHD),
	CONSTRAINT FK_DH FOREIGN KEY (MAHANG) REFERENCES HANGHOA(MAHANG),
	CONSTRAINT FK_HD FOREIGN KEY (MAKH) REFERENCES KHACH(MAKHACH)
)

INSERT INTO HOADON(MAHD , MAHANG , NGAYLAP, SOLUONG , DONGIA , NGAYXUAT , MAKH)
VALUES('HD01' , 'HH01' , '2022-11-10' , 20.00 , 100000.00, '2022-11-15' , 'KH01'),
('HD02' , 'HH02' , '2022-10-15' , 30.00 , 200000.00, '2022-10-15' , 'KH02'),
('HD03' , 'HH02' , '2022-11-01' , 50.00 , 250000.00, '2022-11-01' , 'KH01'),
('HD04' , 'HH03' , '2022-11-02' , 45.00 , 150000.00, '2022-11-02' , 'KH03'),
('HD05' , 'HH01' , '2022-11-03' , 35.00 , 300000.00, '2022-11-15' , 'KH02')

SELECT * FROM HOADON

--Thêm trường TrigiaHD = Soluong*Dongia
UPDATE  HOADON
SET
TRIGIAHD = SOLUONG * DONGIA


--Đưa ra danh sách những hàng hóa được bán với số lượng &gt;40 gồm những thông tin:
--Mã hàng, Tên hàng, số lượng, đơn giá.\

SELECT HOADON.MAHANG , TENHANG , SOLUONG , DONGIA
FROM HOADON
LEFT JOIN HANGHOA
ON HANGHOA.MAHANG = HOADON.MAHANG
WHERE HOADON.SOLUONG >= 40

--Tính tổng số tiền bán hàng của từng mặt hàng. Thông tin hiển thị gồm: Mã hàng, Tên
--hàng, Tổng tiền.

SELECT HOADON.MAHANG , TENHANG , SUM(DONGIA) AS TONG_TIEN FROM HOADON
INNER JOIN HANGHOA
ON HANGHOA.MAHANG = HOADON.MAHANG
GROUP BY HOADON.MAHANG , TENHANG

--Hiền thị danh sách những mặt hàng được xuất trong tháng 11 có trị giá hóa đơn
--&gt;5.000.000đ


SELECT * FROM HOADON
WHERE MONTH(NGAYXUAT) = 11 AND TRIGIAHD >= 5000000

--7. Hiển thị thông tin những mặt hàng chưa được bán (1đ)

SELECT HANGHOA.MAHANG , TENHANG FROM HANGHOA
LEFT JOIN HOADON
ON HOADON.MAHANG = HANGHOA.MAHANG
WHERE HOADON.MAHANG IS NULL

--Tạo bảng lưu thông tin những mặt hàng được xuất trong tháng 11 gồm các thông tin:
--Mã khách hàng, Tên khách hàng, Mã hàng, Tên hàng, trị giá hóa đơn


SELECT HOADON.MAKH , TENKHACH , HOADON.MAHANG  , TENHANG , TRIGIAHD FROM HOADON
LEFT JOIN HANGHOA
ON HANGHOA.MAHANG = HOADON.MAHANG
LEFT JOIN KHACH
ON KHACH.MAKHACH = HOADON.MAKH
WHERE MONTH(HOADON.NGAYXUAT) = 11


--10. Đưa hàng hóa có trị giá lớn nhất

SELECT TOP 1 * FROM HOADON
ORDER BY TRIGIAHD DESC